<div class="gopa-background flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-glass p-6 w-full max-w-4xl animate-fade-in-card relative z-10">
    <!-- Logo -->
    <div class="flex justify-center mb-2">
      <img src="/logo_withoutbg.png" alt="GoPA logo" class="w-32 h-auto object-contain" />
    </div>

    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800 mb-1 tracking-tight">Create Account</h1>
      <p class="text-sm text-gray-600 m-0">Join GoPA and manage your GPA</p>
    </div>

    <!-- Progress Indicator -->
    <div class="flex items-center justify-between mb-5">
      <div class="flex flex-col items-center gap-1" [class.text-blue-500]="currentStep === 1" [class.text-gray-400]="currentStep !== 1">
        <span class="w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm transition-all duration-300" [ngClass]="currentStep >= 1 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'">1</span>
        <span class="text-xs font-semibold uppercase tracking-wide" [ngClass]="currentStep >= 1 ? 'text-blue-500' : 'text-gray-400'">Details</span>
      </div>
      <div class="flex-1 h-0.5 mx-2 transition-colors duration-300" [ngClass]="currentStep > 1 ? 'bg-blue-500' : 'bg-gray-200'"></div>
      <div class="flex flex-col items-center gap-1" [class.text-blue-500]="currentStep === 2" [class.text-gray-400]="currentStep !== 2">
        <span class="w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm transition-all duration-300" [ngClass]="currentStep >= 2 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'">2</span>
        <span class="text-xs font-semibold uppercase tracking-wide" [ngClass]="currentStep >= 2 ? 'text-blue-500' : 'text-gray-400'">Verify</span>
      </div>
      <div class="flex-1 h-0.5 mx-2 transition-colors duration-300" [ngClass]="currentStep > 2 ? 'bg-blue-500' : 'bg-gray-200'"></div>
      <div class="flex flex-col items-center gap-1" [class.text-blue-500]="currentStep === 3" [class.text-gray-400]="currentStep !== 3">
        <span class="w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm transition-all duration-300" [ngClass]="currentStep >= 3 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'">3</span>
        <span class="text-xs font-semibold uppercase tracking-wide" [ngClass]="currentStep >= 3 ? 'text-blue-500' : 'text-gray-400'">Agree</span>
      </div>
    </div>

    <!-- Step 1: Registration Form -->
    <div class="" *ngIf="currentStep === 1">
      <form [formGroup]="registrationForm" (ngSubmit)="submitRegistrationForm()" class="">
        <div class="grid md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div class="space-y-4">
            <!-- Username -->
            <div class="flex flex-col gap-2">
              <label for="username" class="text-sm font-semibold text-gray-700 m-0">Username</label>
              <input
                type="text"
                id="username"
                formControlName="username"
                class="px-4 py-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 outline-none focus:border-blue-500 focus:shadow-[0_0_0_3px_rgba(59,130,246,0.1)]"
                placeholder="Choose your username"
                [class]="username?.invalid && username?.touched ? 'border-red-500 focus:border-red-500 focus:shadow-[0_0_0_3px_rgba(239,68,68,0.1)]' : ''"
              />
              <div class="text-sm text-red-500 min-h-5" *ngIf="username?.invalid && username?.touched">
                Username is required
              </div>
            </div>

            <!-- Index Number -->
            <div class="flex flex-col gap-2">
              <label for="indexNumber" class="text-sm font-semibold text-gray-700 m-0">Index Number</label>
              <input
                type="text"
                id="indexNumber"
                formControlName="indexNumber"
                class="px-4 py-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 outline-none focus:border-blue-500 focus:shadow-[0_0_0_3px_rgba(59,130,246,0.1)]"
                placeholder="21CSE0XXX"
                [class]="indexNumber?.invalid && indexNumber?.touched ? 'border-red-500 focus:border-red-500 focus:shadow-[0_0_0_3px_rgba(239,68,68,0.1)]' : ''"
              />
                <div class="text-sm text-red-500 min-h-5" *ngIf="indexNumber?.invalid && indexNumber?.touched">
                  <span *ngIf="indexNumber?.hasError('required')">Index number is required</span>
                  <span *ngIf="indexNumber?.hasError('pattern')">Index must start with 21CSE0</span>
                </div>
            </div>

            <!-- University Email -->
            <div class="flex flex-col gap-2">
              <label for="email" class="text-sm font-semibold text-gray-700 m-0">University Email</label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="px-4 py-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 outline-none focus:border-blue-500 focus:shadow-[0_0_0_3px_rgba(59,130,246,0.1)]"
                placeholder="xxxxxxxxx@std.foc.sab.ac.lk"
                [class]="email?.invalid && email?.touched ? 'border-red-500 focus:border-red-500 focus:shadow-[0_0_0_3px_rgba(239,68,68,0.1)]' : ''"
              />
              <div class="text-sm text-red-500 min-h-5" *ngIf="email?.touched">
                <span *ngIf="email?.hasError('required')">Email is required</span>
                <span *ngIf="email?.hasError('invalidEmailDomain')">
                  Please use your university email (@std.sab.ac.lk)
                </span>
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-4">
                placeholder="At least 6 characters"
                [class.error]="password?.invalid && password?.touched"
              />
              <div class="error-text" *ngIf="password?.invalid && password?.touched">
                <span *ngIf="password?.hasError('required')">Password is required</span>
                <span *ngIf="password?.hasError('minlength')">Password must be at least 6 characters</span>
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group">
              <label for="confirmPassword" class="form-label">Confirm Password</label>
              <input
                type="password"
                id="confirmPassword"
                formControlName="confirmPassword"
                class="form-input"
                placeholder="Re-enter your password"
                [class.error]="(confirmPassword!.invalid || registrationForm!.hasError('passwordMismatch')) && confirmPassword!.touched"
              />
              <div class="error-text" *ngIf="confirmPassword!.touched">
                <span *ngIf="confirmPassword!.hasError('required')">Please confirm your password</span>
                <span *ngIf="registrationForm!.hasError('passwordMismatch')">Passwords do not match</span>
              </div>
            </div>
          </div>
          
        <!-- Error Message -->
        <div class="error-alert" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="btn-primary"
          [disabled]="registrationForm.invalid || isLoading"
        >
          {{ isLoading ? 'Sending OTP...' : 'Continue' }}
        </button>
      </form>

      <!-- Login Link -->
      <div class="form-footer">
        <p>
          Already have an account?
          <a [routerLink]="['/auth/login']">Login here</a>
        </p>
      </div>
    </div>

    <!-- Step 2: OTP Verification -->
    <div class="step-content" *ngIf="currentStep === 2">
      <div class="otp-section">
        <p class="otp-instruction">We've sent a 6-digit code to {{ userEmail }}</p>

        <form [formGroup]="otpForm" (ngSubmit)="verifyOtp()" class="otp-form">
          <div class="form-group">
            <label for="otp" class="form-label">Enter OTP</label>
            <input
              type="text"
              id="otp"
              formControlName="otp"
              class="form-input otp-input"
              placeholder="000000"
              maxlength="6"
              [class.error]="otp?.invalid && otp?.touched"
            />
            <div class="error-text" *ngIf="otp?.invalid && otp?.touched">
              OTP must be 6 digits
            </div>
          </div>

          <!-- Error Message -->
          <div class="error-alert" *ngIf="errorMessage">
            {{ errorMessage }}
          </div>

          <!-- Success Message -->
          <div class="success-alert" *ngIf="successMessage">
            {{ successMessage }}
          </div>

          <!-- Verify Button -->
          <button
            type="submit"
            class="btn-primary"
            [disabled]="otpForm.invalid || isLoading"
          >
            {{ isLoading ? 'Verifying...' : 'Verify OTP' }}
          </button>
        </form>

        <!-- Back Button -->
        <button type="button" class="btn-secondary" (click)="goBack()">
          Back
        </button>
      </div>
    </div>

    <!-- Step 3: Privacy Policy -->
    <div class="step-content" *ngIf="currentStep === 3">
      <div class="privacy-section">
        <!-- Success Message -->
        <div class="success-alert" *ngIf="successMessage">
          {{ successMessage }}
        </div>

        <!-- Privacy Agreement -->
        <div class="privacy-agreement">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="privacyAgreed"
              class="checkbox-input"
            />
            <span class="checkbox-text">
              I agree to the
              <a [routerLink]="['/auth/privacy']" target="_blank">Privacy and Policy Agreement</a>
            </span>
          </label>
        </div>

        <!-- Error Message -->
        <div class="error-alert" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>

        <!-- Register Button -->
        <button
          type="button"
          class="btn-primary"
          (click)="completeRegistration()"
          [disabled]="!privacyAgreed || isLoading"
        >
          {{ isLoading ? 'Registering...' : 'Complete Registration' }}
        </button>

        <!-- Back Button -->
        <button type="button" class="btn-secondary" (click)="goBack()">
          Back
        </button>
      </div>
    </div>
  </div>
</div>
